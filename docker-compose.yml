services:
  gateway:
    image: openclaw:local
    environment:
      HOME: /home/node
      TERM: xterm-256color
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN:-test-token}
    volumes:
      # Config + session state
      - ./.openclaw-docker:/home/node/.openclaw
      # Mount relay-channel plugin into extensions for auto-discovery
      - ./packages/relay-channel:/home/node/.openclaw/extensions/relay-channel:ro
    ports:
      - "18789:18789"   # Gateway API
      - "7600:7600"     # Relay channel inbound server
    init: true
    restart: unless-stopped
    command:
      [
        "node",
        "openclaw.mjs",
        "gateway",
        "--allow-unconfigured",
        "--bind",
        "lan",
        "--port",
        "18789",
      ]

  relay:
    build:
      context: .
      dockerfile: Dockerfile.relay
    environment:
      DISCORD_TOKEN: ${DISCORD_TOKEN:-}
      SANDBOX_PLUGIN_URL: http://gateway:7600
      SANDBOX_AUTH_TOKEN: test-secret
      CALLBACK_EXTERNAL_URL: http://relay:7601
      CALLBACK_PORT: "7601"
    ports:
      - "7601:7601"     # Callback server
    init: true
    restart: unless-stopped
    depends_on:
      - gateway
    profiles:
      - discord         # Only start with: docker compose --profile discord up
