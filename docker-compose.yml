services:
  gateway:
    image: openclaw:local
    environment:
      HOME: /home/node
      TERM: xterm-256color
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN:-test-token}
    volumes:
      # Config + session state
      - ./.openclaw-docker:/home/node/.openclaw
      # Mount relay-channel plugin into extensions for auto-discovery
      - ./packages/relay-channel:/home/node/.openclaw/extensions/relay-channel:ro
    ports:
      - "18789:18789"   # Gateway API (HTTP + WS)
    init: true
    restart: unless-stopped
    command:
      [
        "node",
        "openclaw.mjs",
        "gateway",
        "--allow-unconfigured",
        "--bind",
        "lan",
        "--port",
        "18789",
      ]

  relay:
    build:
      context: .
      dockerfile: Dockerfile.relay
    environment:
      DISCORD_TOKEN: ${DISCORD_TOKEN:-}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-}
      GATEWAY_URL: http://gateway:18789
      GATEWAY_AUTH_TOKEN: ${OPENCLAW_GATEWAY_TOKEN:-test-token}
      HEALTH_PORT: "8080"
    ports:
      - "8080:8080"     # Health server
    init: true
    restart: unless-stopped
    depends_on:
      - gateway
    profiles:
      - discord         # Only start with: docker compose --profile discord up
      - telegram        # Only start with: docker compose --profile telegram up
